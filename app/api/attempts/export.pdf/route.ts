import { NextResponse } from 'next/server';import { readDB } from '@lib/db';import PDFDocument from 'pdfkit';
export async function GET(){ const db=await readDB(); const doc=new PDFDocument({margin:40}); const chunks:Buffer[]=[]; doc.on('data',(c)=>chunks.push(c as Buffer)); const done=new Promise<Buffer>((resolve)=>{doc.on('end',()=>resolve(Buffer.concat(chunks)));}); doc.fontSize(16).text('Laporan Skor Peserta',{align:'center'}); doc.moveDown(); doc.fontSize(10); const headers=['Tanggal','User','Mission','Final','Acc','Time','Hints']; doc.text(headers.join(' | ')); doc.moveDown(0.5); db.attempts.forEach((a:any)=>{ const row=[a.created_at.split('T')[0],a.user_email,a.mission_id,String(a.finalScore),Math.round(a.accuracy*100)+'%',a.timeTakenSeconds+'s',String(a.hintsUsed)].join(' | '); doc.text(row); }); doc.end(); const buffer=await done; return new NextResponse(buffer,{status:200,headers:{'Content-Type':'application/pdf','Content-Disposition':'attachment; filename="attempts.pdf"'}}); }